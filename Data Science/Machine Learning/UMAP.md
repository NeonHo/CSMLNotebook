UMAP（Uniform Manifold Approximation and Projection，均匀流形逼近与投影）是2018年由Leland McInnes等人提出的一种**降维与可视化算法**。它基于流形学习理论，通过保留高维数据的局部和全局结构，将高维数据映射到低维空间（通常是2D或3D），广泛用于高维数据的可视化（如单细胞测序、图像、文本嵌入等）和预处理。


### 一、UMAP的核心思想
UMAP的核心是**流形学习**：假设高维数据实际分布在一个低维流形上（如曲面、曲线），降维的目标是在低维空间中**近似保留该流形的拓扑结构和几何关系**。

具体来说，UMAP基于两个关键假设：
1. **局部连通性**：高维空间中距离近的点（局部邻居）在低维空间中应保持近邻关系；
2. **全局均匀性**：低维空间应尽可能均匀地分布，避免过度拥挤或稀疏，以保留流形的全局结构。


### 二、UMAP的理论基础
UMAP的设计融合了**拓扑学**和**黎曼几何**的思想，核心是通过“模糊拓扑结构”（fuzzy topological structure）描述高维流形，并在低维空间中近似该结构。

1. **流形与拓扑**：  
   高维数据所在的低维流形可以用“开集”（open sets）描述局部结构，UMAP通过近邻关系模拟这些开集的覆盖关系，确保低维空间保留原有的拓扑连接性（如聚类的连通性）。

2. **距离度量与局部尺度**：  
   高维空间中，两点的相似度基于它们的距离和“局部尺度”（local scale）——即该点到其近邻的平均距离，用于平衡不同密度区域的权重。


### 三、UMAP的算法步骤
UMAP的核心是通过**构建高维近邻图**并**在低维空间中优化该图的结构**，具体步骤如下：


#### 步骤1：构建高维空间的近邻图
- **目标**：用图结构描述高维数据的局部关系，节点为数据点，边的权重表示两点的“连接强度”。
- **具体操作**：
  1. 对每个点$x_i$，找到其$k$个近邻（$k$由参数`n_neighbors`控制），或半径$r$内的邻居（半径邻居）；
  2. 计算局部尺度参数$\sigma_i$：对于点$x_i$，$\sigma_i$是使得其第$k$个近邻的距离对应的概率约为$1/2$的参数（通过二分法求解）；
  3. 计算高维空间中两点$x_i, x_j$的连接概率$p_{ij}$：  
     $$p_{ij} = \frac{1}{2} \left( \exp\left(-\max\left(0, \frac{d(x_i, x_j) - \sigma_i}{\sigma_i}\right)\right) + \exp\left(-\max\left(0, \frac{d(x_i, x_j) - \sigma_j}{\sigma_j}\right)\right) \right)$$  
     其中$d(x_i, x_j)$是高维空间中两点的距离（如欧氏距离），$p_{ij}$表示$x_i$和$x_j$在高维近邻图中的连接强度（范围$[0,1]$）。


#### 步骤2：构建低维空间的近邻图
- **目标**：在低维空间（如2D）中生成点$y_i$，使其近邻关系尽可能接近高维的$p_{ij}$。
- **具体操作**：
  1. 初始化低维点$y_i$（通常用随机正态分布）；
  2. 计算低维空间中两点$y_i, y_j$的连接概率$q_{ij}$：  
     $$q_{ij} = \left(1 + \alpha \cdot d(y_i, y_j)^2\right)^{-\beta}$$  
     其中$\alpha, \beta$是与目标维度相关的常数（如2D时，$\alpha=1.0$，$\beta=1.0$），$d(y_i, y_j)$是低维空间距离。


#### 步骤3：优化低维空间（损失函数最小化）
- **目标**：最小化高维$p_{ij}$和低维$q_{ij}$的差异，保留近邻关系。
- **损失函数**：使用**交叉熵**度量分布差异：  
  $$\text{Loss} = \sum_{i < j} p_{ij} \log\left(\frac{p_{ij}}{q_{ij}}\right) + (1 - p_{ij}) \log\left(\frac{1 - p_{ij}}{1 - q_{ij}}\right)$$  
  但实际计算中，为简化和增强鲁棒性，UMAP通常只对高维中$p_{ij} > 0$的点对（即近邻）计算损失，并加入正则项避免低维点过度拥挤。

- **优化方法**：使用随机梯度下降（SGD）或其变体（如Adam）最小化损失函数，更新低维点$y_i$的坐标。


### 四、UMAP的关键参数
UMAP的效果高度依赖参数设置，核心参数包括：

| 参数名         | 作用                                                                 | 常见取值       |
|----------------|----------------------------------------------------------------------|----------------|
| `n_neighbors`  | 控制近邻数量，平衡局部与全局结构（值越大保留更多全局结构）           | 5~100（默认15） |
| `min_dist`     | 控制低维空间中点的最小距离（值越小，聚类越紧凑；越大，分布越松散）   | 0.01~0.5（默认0.1） |
| `n_components` | 降维后的维度（通常为2或3，用于可视化）                               | 2或3           |
| `metric`       | 高维空间的距离度量（如欧氏距离、余弦距离）                           | 'euclidean'（默认） |


### 五、UMAP与其他降维方法的对比
| 方法        | 优势                  | 劣势               | UMAP的特点            |
| --------- | ------------------- | ---------------- | ------------------ |
| [[t-SNE]] | 局部结构保留好，可视化聚类清晰     | 计算慢，全局结构差，参数敏感   | 更快，全局结构更好，参数更稳定    |
| [[PCA]]   | 线性，计算快，可解释性强        | 无法捕捉非线性结构        | 非线性，能保留流形的非线性关系    |
| UMAP      | 速度快，保留局部+全局结构，支持大数据 | 理论较复杂，参数对结果有一定影响 | 综合性能最优，广泛用于可视化和预处理 |


### 六、UMAP的应用场景
1. **高维数据可视化**：如单细胞RNA-seq数据（展示细胞亚群）、图像特征（展示类别聚类）、文本嵌入（展示语义相似性）；
2. **预处理**：作为分类/聚类的前置步骤，降低维度以减少计算量；[[数据预处理]]
3. **异常检测**：通过低维空间中离群点的分布识别异常样本。


### 总结
UMAP是一种高效、灵活的降维算法，通过融合拓扑学和流形学习思想，在保留局部结构的同时兼顾全局关系，相比t-SNE等方法更适合大规模数据和需要全局结构的场景。理解其核心的“近邻图构建”和“交叉熵优化”过程，有助于更好地调参和解释结果。